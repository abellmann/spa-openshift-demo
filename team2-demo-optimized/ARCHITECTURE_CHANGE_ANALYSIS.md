# Architecture Change Analysis: Nginx Reverse Proxy → OpenShift Routes

## Overview

**Current State:**
- Nginx acts as reverse proxy for both frontend (/) and backend (/api/*)
- Nginx routes are hardcoded in nginx.conf
- Dev environment: Rancher Desktop with Kubernetes
- Test environment: OpenShift with Route resources

**Proposed State:**
- Nginx serves only static frontend content (no reverse proxy)
- OpenShift Route handles reverse proxying for /api/* to backend
- Dev environment: Podman Desktop with OpenShift Local
- Test environment: OpenShift with Route resources (unchanged)
- Frontend and backend applications remain unchanged

---

## Changes Required

### 1. **Nginx Configuration** (`gateway/nginx.conf`)

**Remove:** API reverse proxy configuration
```nginx
# REMOVE THIS ENTIRE SECTION:
location /api/ {
    proxy_pass http://backend-team2:8080/api/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

**Keep:**
- Static file serving (/) with SPA fallback to index.html
- Security headers (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)
- Asset caching for static files (.js, .css, images)
- Health check endpoint (/health)

**Impact:** Simpler nginx.conf, pure static content server

---

### 2. **Kubernetes Manifests**

#### A. Dev Overlay: `k8s/overlays/dev/`

**Current:** Uses NodePort service, local images
**Required Changes:**
- Add `route.yaml` for OpenShift routes (similar to test overlay)
- Update `kustomization.yaml` to reference route.yaml
- Keep `gateway-service-patch.yaml` (changes to ClusterIP instead of NodePort)
- Update environment profile from `kubernetes` to `openshift` (if applicable)

**New file: `k8s/overlays/dev/route.yaml`**
```yaml
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: team2-demo
  namespace: team2-demo
  labels:
    app: gateway-team2
spec:
  host: team2-demo.local  # Or auto-generated by OpenShift Local
  to:
    kind: Service
    name: gateway-team2
    weight: 100
  port:
    targetPort: http
  # TLS optional for local dev
```

**New file: `k8s/overlays/dev/backend-route.yaml`** (for /api/* routing)
```yaml
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: team2-api
  namespace: team2-demo
  labels:
    app: backend-team2
spec:
  host: team2-api.local  # Or prefix on main route
  path: /api
  to:
    kind: Service
    name: backend-team2
    weight: 100
  port:
    targetPort: http
  # TLS optional for local dev
```

**Alternative: Single Route with Multiple Services**
```yaml
# Option: Use a single route with path-based routing
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: team2-demo
  namespace: team2-demo
spec:
  host: team2-demo.local
  to:
    kind: Service
    name: gateway-team2
    weight: 100
  alternateBackends:
    - kind: Service
      name: backend-team2
      weight: 0
  path: /api
```

#### B. Test Overlay: `k8s/overlays/test/`

**No changes needed** - Already uses OpenShift routes correctly

#### C. Gateway Service Patch: `k8s/overlays/dev/gateway-service-patch.yaml`

**Current:**
```yaml
- op: replace
  path: /spec/type
  value: NodePort
- op: replace
  path: /spec/ports/0/nodePort
  value: 30080
```

**New:**
```yaml
- op: replace
  path: /spec/type
  value: ClusterIP  # Routes handle external access
```

---

### 3. **Development Scripts**

#### `dev.sh` Updates

**Changes:**
- Update cluster check from "Rancher Desktop" to "OpenShift Local" or generic Kubernetes
- Keep build/deploy logic (unchanged)
- Update port-forward instructions (routes handle access, no need for port-forward)
- Update access instructions to use route hostname

**Before:**
```bash
echo "Port-forward to access:"
echo "  kubectl port-forward -n team2-demo svc/gateway-team2 3000:8080"
echo "  open http://localhost:3000"
```

**After:**
```bash
echo "Access via route:"
echo "  oc get route -n team2-demo team2-demo"
echo "  # Or: kubectl get route -n team2-demo"
```

---

### 4. **Documentation Updates**

#### A. `README.md`

**Current Dev Section:**
- References Rancher Desktop
- Shows port-forward access pattern
- Mentions local Kubernetes

**Changes:**
- Update to "Podman Desktop with OpenShift Local"
- Remove port-forward instructions
- Show route access pattern
- Emphasize that OpenShift Local provides full OpenShift experience

#### B. `DEVBOX_QUICK_START.md` & `DEVBOX_SETUP.md`

**Changes:**
- Update prerequisites: Podman Desktop (instead of/alongside Rancher Desktop)
- Note OpenShift Local extension requirement
- Update quick start instructions

#### C. New: Dev Overlay `k8s/overlays/dev/README.md`

**Update existing file:**
- Explain route-based access
- Note differences from test overlay (local vs registry images, route hostname)
- Provide commands to get route URL

---

### 5. **Profile/Environment Configuration**

#### `backend/src/main/resources/application.yml`

**Check if exists:** Currently, does backend have profiles for `kubernetes` vs `openshift`?

**If using profiles:**
- Could keep both (dev and test both use `openshift` profile now)
- Or consolidate to single profile

**If not using profiles:**
- No changes needed

---

### 6. **Frontend Application**

**No changes needed** - `api.service.ts` continues to call `/api/*` endpoints
- With nginx reverse proxy: Nginx translates /api/* → backend:8080/api/*
- With OpenShift routes: Route translates /api/* → backend-team2:8080/api/*
- End result: Same from frontend perspective

---

### 7. **Backend Application**

**No changes needed** - Continues to listen on port 8080 with /api/* endpoints

---

## Implementation Checklist

### Phase 1: Analysis & Review (Now)
- [x] Understand current architecture
- [x] Document all required changes
- [x] Identify impact areas
- [ ] **User review & approval**

### Phase 2: Implementation (Pending review)
- [ ] Simplify `gateway/nginx.conf` (remove /api/ proxy)
- [ ] Create `k8s/overlays/dev/route.yaml`
- [ ] Update `k8s/overlays/dev/gateway-service-patch.yaml`
- [ ] Update `k8s/overlays/dev/kustomization.yaml`
- [ ] Update `dev.sh` script
- [ ] Update documentation (README.md, DEVBOX_*.md)
- [ ] Test with OpenShift Local/Podman Desktop

### Phase 3: Validation
- [ ] Verify frontend loads (/api calls work)
- [ ] Verify backend responds
- [ ] Verify health endpoints
- [ ] Test both dev and test environments

---

## Risk Assessment

### Low Risk:
- Nginx changes (removing config, not adding)
- Frontend/backend unchanged
- Documentation updates

### Medium Risk:
- Route configuration complexity (ensure correct path routing)
- Cluster check logic in dev.sh (needs generic check)

### Mitigation:
- Keep nginx.conf copy for reference
- Test dev.sh with actual Podman Desktop/OpenShift Local
- Validate routes are correctly routing traffic

---

## Questions for Review

1. **Route hostname in dev:** Should it be `team2-demo.local` (hardcoded) or let OpenShift auto-generate?
2. **Single vs multiple routes:** One route with path-based routing, or separate frontend/backend routes?
3. **CORS headers:** Not needed; routes keep traffic same-origin, backend no longer sets permissive CORS
4. **TLS in dev:** Should dev routes include TLS (edge termination) or just HTTP?
5. **Backend route path:** Should it be `/api` on main domain or separate subdomain?

---

## Files to Modify

1. `gateway/nginx.conf` - Remove /api/ location block
2. `k8s/overlays/dev/kustomization.yaml` - Add route.yaml reference
3. `k8s/overlays/dev/gateway-service-patch.yaml` - Change NodePort to ClusterIP
4. `k8s/overlays/dev/route.yaml` - **NEW FILE**
5. `dev.sh` - Update cluster check and access instructions
6. `README.md` - Update dev environment section
7. `DEVBOX_QUICK_START.md` - Update prerequisites
8. `DEVBOX_SETUP.md` - Update prerequisites
9. `k8s/overlays/dev/README.md` - Update if exists

---

## No Changes Needed

- `backend/` - Application code unchanged
- `frontend/` - Application code unchanged
- `docker/Dockerfile.*` - Unchanged
- `k8s/base/` - Unchanged
- `k8s/overlays/test/` - Unchanged
- `build.sh`, `deploy.sh` - Unchanged
- `devbox.json`, `.devbox-template.nix` - Unchanged
